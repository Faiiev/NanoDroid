#!/bin/bash

VERSION=22.3.20190805
CWD=$(readlink -m "${BASH_SOURCE[0]}")
CWD=$(dirname "${CWD}")

for funcfile in  pkg update common download database report; do
	source "${CWD}/data/build-package.${funcfile}" || exit 1
done

[[ -z ${1} ]] && show_help

for opt in ${@}; do
	case ${opt} in
		full)
			check_nanodroid || error "run 'build-package pull' first!"
			mk_pkg_full
		;;

		microg )
			check_nanodroid || error "run 'build-package pull' first!"
			mk_pkg_microg
		;;

		fdroid )
			check_nanodroid || error "run 'build-package pull' first!"
			mk_pkg_fdroid
		;;

		patcher )
			mk_pkg_patcher
		;;

		uninstaller )
			mk_pkg_uninstaller
		;;

		setupwizard )
			mk_pkg_setupwizard
		;;

		bromitewebview )
			check_nanodroid || error "run 'build-package pull' first!"
			mk_pkg_bromite_webview
		;;

		osmand )
			check_nanodroid || error "run 'build-package pull' first!"
			mk_pkg_osmand
		;;

		systest )
			mk_pkg_systest
		;;

		all )
			check_nanodroid || error "run 'build-package pull' first!"
			mk_pkg_full
			mk_pkg_microg
			mk_pkg_fdroid
			mk_pkg_patcher
			mk_pkg_uninstaller
			mk_pkg_setupwizard
			mk_pkg_bromite_webview
			mk_pkg_osmand
			mk_pkg_systest
			create_report
		;;

		ver )
			increase_version_number "${@}"
		;;

		bump )
			increase_module_version
		;;

		dalvik )
			dalvikize_jar "${2}"
		;;

		pull )
			update_indices
			nanodroid_pull
			check_nanodroid
		;;

		u-microg )
			update_indices
			update_microg
			check_nanodroid
		;;

		u-fdroid )
			update_indices
			update_fdroid
			check_nanodroid
		;;

		u-apps )
			update_indices
			update_apps
			check_nanodroid
		;;

		u-swipe )
			update_swipe
			check_nanodroid
		;;

		u-gsync )
			update_gsync
			check_nanodroid
		;;

		u-bromite )
			update_indices
			update_bromite
			check_nanodroid
		;;

		u-osmand )
			update_indices
			update_osmand
			check_nanodroid
		;;

		u-patch )
			update_patches
		;;

		check )
			check_nanodroid
		;;

		clean )
			echo -ne "\nAre you sure to delete all untracked files?\n >> enter [y] or [j] to continue: "
			read -r user_input

			case "${user_input}" in
				y | Y | j | J )
					git clean -fd
				;;

				* )
					echo "aborted"
				;;
			esac
		;;

		report )
			check_nanodroid || error "run 'build-package pull' first!"
			create_report
		;;

		* )
			show_help
		;;
	esac
done
